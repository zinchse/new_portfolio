<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>True Parallelism vs Python | Sergey E. Zinchenko</title>
    <meta name="author" content="Sergey E. Zinchenko">
    <meta name="description" content="Breaking stereotypes about parallelism in python with examples.">
    <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website">


    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous">

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light">

    <!-- Styles -->
    
    <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;">
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="https://zinchse.github.io/blog/2023/parallel-python/">
    
    <!-- Dark Mode -->
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark">

    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/dark_mode.js"></script>
    

  </head>

  <!-- Body -->
  <body class="fixed-top-nav ">

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Sergey </span>E. Zinchenko</a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">about</a>
              </li>
              
              <!-- Blog -->
              <li class="nav-item active">
                <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a>
              </li>

              <!-- Other pages -->
              <li class="nav-item ">
                <a class="nav-link" href="/publications/">publications</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/cv/">cv</a>
              </li>

              <!-- Toogle theme mode -->
              <li class="toggle-container">
                <button id="light-toggle" title="Change theme">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
                </button>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <!-- Scrolling Progress Bar -->
      <progress id="progress" value="0">
        <div class="progress-container">
          <span class="progress-bar"></span>
        </div>
      </progress>
    </header>


    <!-- Content -->
    <div class="container mt-5">
      <!-- _layouts/post.html -->

<div class="post">

  <header class="post-header">
    <h1 class="post-title">True Parallelism vs Python</h1>
    <p class="post-meta">November 24, 2023</p>
    <p class="post-tags">
      <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>
        ·  
        <a href="/blog/category/code">
          <i class="fas fa-tag fa-sm"></i> code</a>  
          

    </p>
  </header>

  <article class="post-content">
    <h1 id="introduction">Introduction</h1>

<h3 id="goals">Goals</h3>

<p>The purpose of this text is to find answers to the following questions (yes, these questions are not about the same thing …):</p>
<ul>
  <li>is parallelism possible in python?</li>
  <li>is true parallelism possible in python?</li>
  <li>is true parallelism possible in python for cpu bound tasks?</li>
</ul>

<p>At the same time we will get acquainted with GIL and understand why it is so important. We will also learn why it may be useful to avoid it. And of course, we’ll learn how to do it (since it’s important). At the end, I will talk a bit about funny features of synchronization primitives in Python (I came across them while studying the topic, then I have to share them with someone).</p>

<h3 id="true-parallelism">True Parallelism</h3>

<p>Let’s begin by defining what <em>real parallelism</em> is. I will take it to mean the possibility of executing several program instructions at once at a particular moment of time. This can be done, for example, when there are several processor cores.</p>

<p>In the end, any program is represented as a set of some machine operations. And, obviously, someone has to execute them (it can be a TPU / GPU; but in our case it will be a CPU device, aka processor). In modern systems, a CPU has several cores at once. And I will call true parallelism the case when we achieve a gain in the speed of program execution due to their use.</p>

<h3 id="non-true-parallelism">Non-true Parallelism</h3>

<p>One might ask, then what is non-true parallelism? For example, if we execute 2 programs on one processor core and switch between them so quickly that the user does not notice anything, it can be called parallelism - from the user’s point of view 2 programs work simultaneously. But in reality there is only one program running at each moment of time and such parallelism is not true. It is an illusion. And it can be useful. But it’s completely inappropriate for a scenario where we need to speed up a single heavy task. And this case isn’t rare.</p>

<h1 id="threads-vs-process">Threads vs Process</h1>

<p>The two main classes of tasks are cpu and io (input/output) bound tasks. They differ by the fact that the first class of tasks requires CPU work most of the time, while in the second type of tasks waiting for some third-party services (disk, database, etc.) to respond plays a significant role.</p>

<p>There is a fundamental difference between io and cpu bound tasks: <em>io bound tasks can be easily and efficiently parallelized</em> if you pause execution of one code branch at the moment of waiting for the response of some third-party service and switch to another. In case of a cpu bound task this trick <strong>will not work</strong> - if we give the processor core to someone else, the progress of our execution will not move anywhere and we will increase the total running time.</p>

<p>Let’s make sure I’m not making anything up.</p>

<h3 id="example-1---io-bound-task">Example 1 - io bound task</h3>

<p>As an io bound task, we will use a function that <del>just sleeps</del> simulates waiting for an external service to respond.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">io_task</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="sh">'</span><span class="s">None</span><span class="sh">'</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">N_ITER</span><span class="p">):</span>
        <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.00000001</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>results (thread):</strong></p>
<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code>100%|██████████| 24/24 [01:09&lt;00:00,  2.89s/it]
[# threads = 1, # tasks = 24, workload = io]
<span class="gh">Total time 69.4541 s
------------------------------------------------------------
</span>100%|██████████| 24/24 [00:45&lt;00:00,  1.89s/it]
[# threads = 2, # tasks = 24, workload = io]
<span class="gh">Total time 45.4068 s
------------------------------------------------------------
</span></code></pre></div></div>

<p><strong>results (process):</strong></p>
<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code>100%|██████████| 24/24 [01:09&lt;00:00,  2.90s/it]
[# processes = 1, workload = io]
<span class="gh">Total time 69.5136 s
------------------------------------------------------------
</span>100%|██████████| 24/24 [00:48&lt;00:00,  2.01s/it]
[# processes = 2, workload = io]
<span class="gh">Total time 48.2397 s
------------------------------------------------------------
</span></code></pre></div></div>

<p><strong>Conclusion:</strong>
io bound tasks can be accelerated in python by both threads and processes</p>

<h3 id="example-2--cpu-bound-task">Example 2 – cpu bound task</h3>

<p>Here we will use another function, which loads the processor with <del>useless</del> additions of numbers</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">cpu_task</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="sh">'</span><span class="s">int</span><span class="sh">'</span><span class="p">:</span>
    <span class="n">res</span><span class="p">:</span> <span class="sh">'</span><span class="s">int</span><span class="sh">'</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">N_ITER</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2023</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">+=</span> <span class="n">i</span>    
    <span class="k">return</span> <span class="n">res</span>
</code></pre></div></div>

<p><strong>results (thread):</strong></p>
<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code>100%|██████████| 24/24 [00:00&lt;00:00, 87.65it/s] 
[# threads = 1, # tasks = 24, workload = cpu]
<span class="gh">Total time 0.6310 s
------------------------------------------------------------
</span>100%|██████████| 24/24 [00:00&lt;00:00, 139.97it/s]
[# threads = 2, # tasks = 24, workload = cpu]
<span class="gh">Total time 0.6166 s
------------------------------------------------------------
</span></code></pre></div></div>

<p><strong>results (process):</strong></p>
<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code>100%|██████████| 24/24 [00:00&lt;00:00, 35.09it/s]
[# processes = 1, workload = cpu]
<span class="gh">Total time 0.7013 s
------------------------------------------------------------
</span>100%|██████████| 24/24 [00:00&lt;00:00, 68.16it/s]
[# processes = 2, workload = cpu]
<span class="gh">Total time 0.3638 s
------------------------------------------------------------
</span></code></pre></div></div>

<p><strong>Conclusions:</strong></p>

<p>But cpu bound tasks are not accelerated by creating additional threads (at least in python). So I didn’t lie to you.</p>

<h3 id="results">Results</h3>

<p>Ok, we get it. There are some problems with threads in Python. Then just use processes and be happy. But wait. I ran a sample with 1000 processes and noticed something unusual. I think I’m running out of memory …</p>

<p>Let’s see in real time how much memory is used to support a python process and see how much memory is consumed by python:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">print_mem</span><span class="p">():</span>
    <span class="n">total_memory</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">psutil</span><span class="p">.</span><span class="nf">process_iter</span><span class="p">([</span><span class="sh">'</span><span class="s">pid</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">memory_info</span><span class="sh">'</span><span class="p">]):</span>
        <span class="k">if</span> <span class="sh">'</span><span class="s">Python</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">proc</span><span class="p">.</span><span class="n">info</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]:</span>
            <span class="n">total_memory</span> <span class="o">+=</span> <span class="n">proc</span><span class="p">.</span><span class="n">info</span><span class="p">[</span><span class="sh">'</span><span class="s">memory_info</span><span class="sh">'</span><span class="p">].</span><span class="n">rss</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Total Python</span><span class="sh">'</span><span class="s">s memory: </span><span class="si">{</span><span class="n">total_memory</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="si">}</span><span class="s"> MB</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Total Python's memory: 61.703125 MB
</code></pre></div></div>

<p>That’s on the order of <code class="language-plaintext highlighter-rouge">20mB</code> per process (I had 3 process when i called it)! That’s a lot, to put it mildly. Maybe it will be possible to make cpu bound task friends with threads?</p>

<h1 id="threads--cpu-bound-task">Threads &amp; cpu bound task</h1>

<p>To really realize what is the reason for such interaction of threads and cpu bound tasks, we should dive into the process of python code execution in more detail. It will not be easy. It will be difficult. It will be <em>uninteresting</em>. But we will do it. Then it will become obvious what is the bottleneck in the entire system. And to get around that limitation, we’ll resort to a <em>secret technique</em> …</p>

<h3 id="pythons-code-execution">
<code class="language-plaintext highlighter-rouge">Python</code>s code execution</h3>

<p>The process of code execution in Python can be broken down into several main steps:</p>

<p><strong>1. In first, we just write the code, for example, in the <code class="language-plaintext highlighter-rouge">file.py</code> file:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">The real science</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>2. Secondly, this code is compiled into some intermediate representation (byte code), which is something between source code and assembly language; in our case we will get a file <code class="language-plaintext highlighter-rouge">file.pyc</code> with the following contents:</strong></p>

<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 0 LOAD_GLOBAL              0 (print)
 2 LOAD_CONST               1 ('The real science.')
 4 CALL_FUNCTION            1
 6 POP_TOP
 8 LOAD_CONST               0 (None)
10 RETURN_VALUE
</code></pre></div></div>

<p><strong>3. After that, Python Virtual Machine is started, which, reading instructions from the <code class="language-plaintext highlighter-rouge">.pyc</code> file, generates hardware-specific machine code.</strong></p>

<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code>11101011101101010110
</code></pre></div></div>

<p>Now we can see that to correctly translate instructions from byte code to machine code, we need a separate program – <em>interpreter</em>. And for each process, this interpreter is unique. Therefore, at no point in time can multiple python threads execute instructions on the processor – each of those instructions needs the help of the interpreter, which is one. Moreover, each thread acquires a special <em>Global Interpreter Lock</em> to, for example, <em>simplify memory management</em>: if we know that only one thread is running at any given moment, it is easy to keep track of the reference count of all objects, and as a consequence - we can delete then and only when its reference count goes to zero.</p>

<h3 id="avoiding-gil-via-cython">Avoiding GIL via <code class="language-plaintext highlighter-rouge">Cython</code>
</h3>

<p>Good. Now we can see that the root of the problem is the need to interpret byte code. What if we somehow write code that can be turned into machine code without the need for interpretation? For example, <code class="language-plaintext highlighter-rouge">C++</code> code does not require this extra step. Indeed, we can use a special <code class="language-plaintext highlighter-rouge">Cython</code> tool that allows us to write code using <code class="language-plaintext highlighter-rouge">C</code>-like syntax that can be executed bypassing the interpreter.</p>

<p>What do we end up with? If we have the ability to write code that won’t lock the interpreter (e.g. using <code class="language-plaintext highlighter-rouge">Cython</code>), then already <strong>multiple python threads can be executed on different cores at the same time</strong>! And this is exactly what we wanted. Let’s try to do all this.</p>

<p>/* I did it all honestly and posted the notebook here <a href="https://github.com/zinchse/parallel_python/tree/main" rel="external nofollow noopener" target="_blank">here</a>. The visualization of the result is roughly as follows: */</p>

<figure style="display: block; margin: auto; text-align: center;">
    <img src="/assets/img/cython_vs_python.png" alt="Cython vs Python" width="500px">
    <figcaption>
        An example of accelerating Python's threads 
        <br>
        by using Cython.
    </figcaption>
</figure>

<h1 id="remark">Remark</h1>

<p>This <a href="https://github.com/zinchse/parallel_python/tree/main" rel="external nofollow noopener" target="_blank">repository</a> contains code that reproduces all the previously mentioned points. Also there you can see some peculiarities of the implementation of locks and semaphores in python, with which you can a) steal money and b) break the synchronization primitives. Good luck!</p>

<p><strong>Used resources:</strong></p>
<ul>
  <li><a href="https://docs.python.org/3/library/concurrency.html" rel="external nofollow noopener" target="_blank">python’s doc</a></li>
  <li><a href="https://www.youtube.com/watch?v=z7WIm0iZcOU&amp;ab_channel=%D0%94%D0%B8%D0%B4%D0%B6%D0%B8%D1%82%D0%B0%D0%BB%D0%B8%D0%B7%D0%B8%D1%80%D1%83%D0%B9%21" rel="external nofollow noopener" target="_blank">video 1</a></li>
  <li><a href="https://www.youtube.com/watch?v=nR8WhdcRJwM&amp;t=3141s&amp;ab_channel=ComputerScienceCenter" rel="external nofollow noopener" target="_blank">video 2, very hot!</a></li>
  <li><a href="https://www.youtube.com/watch?v=w2-QoVB1TnQ&amp;ab_channel=ComputerScienceCenter" rel="external nofollow noopener" target="_blank">video 3</a></li>
  <li><a href="https://www.geeksforgeeks.org/internal-working-of-python/" rel="external nofollow noopener" target="_blank">gksfgks</a></li>
</ul>

  </article><div id="disqus_thread" style="max-width: 600px; margin: 0 auto;">
    <script type="text/javascript">
        var disqus_shortname  = 'al-folio';
        var disqus_identifier = '/blog/2023/parallel-python';
        var disqus_title      = "True Parallelism vs Python";
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by Disqus.</a>
</noscript>
</div>
</div>

    </div>

    <!-- Footer -->    
    <footer class="fixed-bottom">
      <div class="container mt-0">
        © Copyright 2023 Sergey E. Zinchenko. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>.
Last updated: November 25, 2023.
      </div>
    </footer>

    <!-- JavaScripts -->
    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    <!-- Masonry & imagesLoaded -->
  <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/masonry.js" type="text/javascript"></script>
    
  <!-- Medium Zoom JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script>
  <script defer src="/assets/js/zoom.js"></script><!-- Load Common JS -->
  <script defer src="/assets/js/common.js"></script>
  <script defer src="/assets/js/copy_code.js" type="text/javascript"></script>

    
  <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script>
  <script async src="https://badge.dimensions.ai/badge.js"></script>

    <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    
    

<!-- Scrolling Progress Bar -->
<script type="text/javascript">
  /*
   * This JavaScript code has been adapted from the article 
   * https://css-tricks.com/reading-position-indicator/ authored by Pankaj Parashar, 
   * published on the website https://css-tricks.com on the 7th of May, 2014.
   * Couple of changes were made to the original code to make it compatible 
   * with the `al-foio` theme.
   */
  const progressBar = $("#progress");
  /*
   * We set up the bar after all elements are done loading.
   * In some cases, if the images in the page are larger than the intended
   * size they'll have on the page, they'll be resized via CSS to accomodate
   * the desired size. This mistake, however, breaks the computations as the
   * scroll size is computed as soon as the elements finish loading.
   * To account for this, a minimal delay was introduced before computing the
   * values.
   */
  window.onload = function () {
    setTimeout(progressBarSetup, 50);
  };
  /*
   * We set up the bar according to the browser.
   * If the browser supports the progress element we use that.
   * Otherwise, we resize the bar thru CSS styling
   */
  function progressBarSetup() {
    if ("max" in document.createElement("progress")) {
      initializeProgressElement();
      $(document).on("scroll", function() {
        progressBar.attr({ value: getCurrentScrollPosition() });
      });
      $(window).on("resize", initializeProgressElement);
    } else {
      resizeProgressBar();
      $(document).on("scroll", resizeProgressBar);
      $(window).on("resize", resizeProgressBar);
    }
  }
  /*
   * The vertical scroll position is the same as the number of pixels that
   * are hidden from view above the scrollable area. Thus, a value > 0 is
   * how much the user has scrolled from the top
   */
  function getCurrentScrollPosition() {
    return $(window).scrollTop();
  }

  function initializeProgressElement() {
    let navbarHeight = $("#navbar").outerHeight(true);
    $("body").css({ "padding-top": navbarHeight });
    $("progress-container").css({ "padding-top": navbarHeight });
    progressBar.css({ top: navbarHeight });
    progressBar.attr({
      max: getDistanceToScroll(),
      value: getCurrentScrollPosition(),
    });
  }
  /*
   * The offset between the html document height and the browser viewport
   * height will be greater than zero if vertical scroll is possible.
   * This is the distance the user can scroll
   */
  function getDistanceToScroll() {
    return $(document).height() - $(window).height();
  }

  function resizeProgressBar() {
    progressBar.css({ width: getWidthPercentage() + "%" });
  }
  // The scroll ratio equals the percentage to resize the bar
  function getWidthPercentage() {
    return (getCurrentScrollPosition() / getDistanceToScroll()) * 100;
  }
</script>

  </body>
</html>
